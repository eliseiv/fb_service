import regex as re
from typing import Optional
from urllib.parse import unquote

from parsel import Selector

from app.domain.facebook import Page, FacebookBaseParser, FacebookWeb2Parser
from app.domain.utils.logutils import init_logger
from app.infrastructure.schemas import FacebookItem
from app.infrastructure.settings import LOG_DIR

logger = init_logger(filename="facebook_web.log", logdir=str(LOG_DIR))


class FacebookWebParser:
    @staticmethod
    def __parse_likes_intro(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '(//div[@role="main"])[1]//a[contains(@href, "_like")]//text()')
            text = " ".join([e.get().strip() for e in elems])
            text = re.sub(r'like[s]?', '', text)
            result = text.strip()
        except Exception as err:
            logger.error(err)

        return result

    @staticmethod
    def __parse_likes_about(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "-168px -105px")]'
                '/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            text = re.sub(r'\b\s+(people|person)\s+like[s]?\s+this\b', '', text)
            result = text.strip()
        except Exception as err:
            logger.error(err)

        return result

    @staticmethod
    def __parse_followers_intro(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath('(//div[@role="main"])[1]//a[contains(@href, "follower")]//text()')
            text = " ".join([e.get().strip() for e in elems])
            text = re.sub(r'follower[s]?', '', text)
            result = text.strip()
        except Exception as err:
            logger.error(err)

        return result

    @staticmethod
    def __parse_followers_about(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "0px -176px")]'
                '/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            text = re.sub(r'\b\s+(people|person)\s+follow[s]?\s+this\b', '', text)
            result = text.strip()
        except Exception as err:
            logger.error(err)

        return result

    @staticmethod
    def __parse_email_intro(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//img[contains(@src,"2PIcyqpptfD.png")]/parent::div/following-sibling::div//text()')
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)

        return result

    @staticmethod
    def __parse_email_about(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "0px -155px")]'
                '/parent::div/following-sibling::div//text()')
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)

        return result

    @staticmethod
    def __parse_phone_intro(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//img[contains(@src,"Dc7-7AgwkwS.png")]/parent::div/following-sibling::div//text()')
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)
        return result

    @staticmethod
    def __parse_phone_about(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "-63px -126px")]'
                '/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)
        return result

    @staticmethod
    def __parse_web_intro(selector: Selector) -> str:
        result = ""
        pattern = re.compile(r'\?u\=((.+))&', re.IGNORECASE)
        try:
            text = selector.xpath(
                '//img[contains(@src,"BQdeC67wT9z.png")]/parent::div/following-sibling::div//a/@href').get()

            if not text:
                return result

            found = pattern.search(text.strip())
            if found:
                und = found[1]
                result = unquote(und)
        except Exception as e:
            logger.error(e)

        return result

    @staticmethod
    def __parse_web_about(selector: Selector) -> str:
        result = ""
        pattern = re.compile(r'\?u\=((.+))&', re.IGNORECASE)
        try:
            text = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "0px -260px")]'
                '/parent::div/following-sibling::div//text()'
            ).get()

            if not text:
                return result

            found = pattern.search(text.strip())
            if found:
                und = found[1]
                result = unquote(und)
        except Exception as err:
            logger.error(err)
        return result

    @staticmethod
    def __parse_address_intro(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//img[contains(@src,"8k_Y-oVxbuU.png")]/parent::div/following-sibling::div//text()')
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)
        return result

    @staticmethod
    def __parse_address_about(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "-84px -126px")]'
                '/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)
        return result

    @staticmethod
    def __parse_price_range_intro(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//img[contains(@src,"vUmfhJXfJ5R.png")]/parent::div/following-sibling::div//text()')
            text = " ".join([e.get().strip() for e in elems])
            matches = re.findall(r'\$+', text, flags=re.I)
            result = matches[0].strip() if len(matches) > 0 else ""
        except Exception as e:
            logger.error(e)

        return result

    @staticmethod
    def __parse_price_range_about(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "0px -134px")]'
                '/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            matches = re.findall(r'\$+', text, flags=re.I)
            result = matches[0].strip() if len(matches) > 0 else ""
        except Exception as err:
            logger.error(err)
        return result

    @staticmethod
    def __parse_category_intro(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//img[contains(@src,"4PEEs7qlhJk.png")]/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            result = text.replace('Page Â·', '').strip()
        except Exception as e:
            logger.error(e)

        return result

    @staticmethod
    def __parse_category_about(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//i[@data-visualcompletion="css-img" and contains(@style, "0px -42px")]'
                '/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)
        return result

    # PARSE METHODS
    def parse_likes(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_likes_intro(selector)
            if not result:
                result = self.__parse_likes_about(selector)
        except Exception as e:
            logger.error(e)

        return result

    def parse_followers(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_followers_intro(selector)
            if not result:
                result = self.__parse_followers_about(selector)
        except Exception as e:
            logger.error(e)

        return result

    def parse_likes_followers(self, selector: Selector) -> str:
        result = ""
        try:
            likes_ = self.parse_likes(selector)
            followers_ = self.parse_followers(selector)
            result = likes_
            if followers_.strip():
                result += f"/{followers_}"
        except Exception as e:
            logger.error(e)

        return result

    def parse_email(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_email_intro(selector)
            if not result:
                result = self.__parse_email_about(selector)
        except Exception as e:
            logger.error(e)

        return result

    def parse_phone(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_phone_intro(selector)
            if not result.strip():
                result = self.__parse_phone_about(selector)
        except Exception as err:
            logger.error(err)
        return result

    def parse_web(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_web_intro(selector)
            if not result:
                result = self.__parse_web_about(selector)
        except Exception as e:
            logger.error(e)

        return result

    def parse_address(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_address_intro(selector)
            if not result:
                result = self.__parse_address_about(selector)
        except Exception as e:
            logger.error(e)

        return result

    def parse_price_range(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_price_range_intro(selector)
            if not result:
                result = self.__parse_price_range_about(selector)
        except Exception as e:
            logger.error(e)

        return result

    def parse_category(self, selector: Selector) -> str:
        result = ""
        try:
            result = self.__parse_category_intro(selector)
            if not result:
                result = self.__parse_category_about(selector)
        except Exception as e:
            logger.error(e)

        return result

    @staticmethod
    def parse_title(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath('(//h1)[1]//text()')
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as err:
            logger.error(err)

        return result

    def parse_price_delivery(self, selector: Selector) -> str:
        result = ""
        try:
            price = self.parse_price_range(selector)
            delivery = self.parse_service(selector)
            result = price.strip()
            if delivery.strip():
                result += f'/{delivery}'
        except Exception as e:
            logger.error(e)

        return result

    @staticmethod
    def parse_rating(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath('.//img[contains(@src,"4Lea07Woawi.png")]/parent::div/following-sibling::div//text()')
            text = " ".join([e.get().strip() for e in elems])
            text = text.replace(",", "")
            parts = re.findall(r'\d+\.?\d*', text, flags=re.I)
            rating_ = parts[0].strip() if len(parts) > 0 else ""
            if '0' == rating_.strip() or '0.0' == rating_.strip():
                rating_ = ""
            review_ = parts[1].strip() if len(parts) > 1 else ""
            if '0' == rating_.strip():
                rating_ = ""
            if rating_ and review_:
                result = f"{rating_}/{review_}"
            elif rating_:
                result = rating_
            elif review_:
                result = review_
        except Exception as e:
            logger.error(e)

        return result

    @staticmethod
    def parse_descr(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//div[contains(@class,"xieb3on")]/div[1]//text()')

            if not elems:
                elems = selector.xpath(
                    '//div[contains(@class,"xdppsyt")]//text()')

            if elems:
                text = " ".join([e.get().strip() for e in elems])
                result = text.strip()
        except Exception as e:
            logger.error(f"Error parsing description: {e}")

        return result

    # def parse_descr(selector: Selector) -> str:
    #     result = ""
    #     try:
    #         # ĞĞ¾Ğ²ÑĞ¹ ÑĞµĞ»ĞµĞºÑĞ¾Ñ - Ğ¸ÑĞµĞ¼ span Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼ Ğ² Ğ¿ĞµÑĞ²Ğ¾Ğ¼ div xieb3on
    #         elems = selector.xpath(
    #             '//div[contains(@class,"xieb3on")]/div[1]//span[contains(@class,"x193iq5w") and @dir="auto"]/text()')
    #
    #         if not elems:
    #             # Ğ¡ÑĞ°ÑÑĞ¹ ÑĞµĞ»ĞµĞºÑĞ¾Ñ 1
    #             elems = selector.xpath(
    #                 '//div[contains(@class,"xieb3on")]/div[1]//text()')
    #
    #         if not elems:
    #             # ĞĞ¾Ğ²ÑĞ¹ ÑĞµĞ»ĞµĞºÑĞ¾Ñ - Ğ¸ÑĞµĞ¼ span Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼
    #             elems = selector.xpath(
    #                 '//div[contains(@class,"xieb3on")]//span[contains(@class,"x193iq5w")]/text()')
    #
    #         if not elems:
    #             # ĞĞ¾Ğ²ÑĞ¹ ÑĞµĞ»ĞµĞºÑĞ¾Ñ - Ğ¸ÑĞµĞ¼ span Ñ dir="auto"
    #             elems = selector.xpath(
    #                 '//div[contains(@class,"xieb3on")]//span[@dir="auto"]/text()')
    #
    #         if not elems:
    #             elems = selector.xpath(
    #                 '//div[contains(@class,"xieb3on")]//text()')
    #
    #         if not elems:
    #             elems = selector.xpath(
    #                 '//div[contains(@class,"xdppsyt")]//text()')
    #
    #         if elems:
    #             text = " ".join([e.get().strip() for e in elems])
    #             result = text.strip()
    #             if result:
    #                 logger.info(f"Found description: '{result[:100]}...'")
    #         else:
    #             logger.info("No description elements found with current selectors")
    #     except Exception as e:
    #         logger.error(f"Error parsing description: {e}")
    #
    #     return result

    @staticmethod
    def parse_service(selector: Selector) -> str:
        result = ""
        try:
            elems = selector.xpath(
                '//img[contains(@src,"arM1m3sNXPr.png")]/parent::div/following-sibling::div//text()'
            )
            text = " ".join([e.get().strip() for e in elems])
            result = text.strip()
        except Exception as e:
            logger.error(e)

        return result

    @staticmethod
    def parse_logo(selector: Selector) -> str:
        link = ""
        try:
            # ĞĞ°ÑĞ¾Ğ´Ğ¸Ğ¼ Ğ¿ĞµÑĞ²ÑĞ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ image Ğ²Ğ½ÑÑÑĞ¸ svg
            image_elements = selector.xpath("(//svg//image)[1]")

            # ĞÑĞ¾Ğ²ĞµÑÑĞµĞ¼, ÑÑĞ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
            if image_elements:
                image_element = image_elements[0]
                # ĞÑĞ¾Ğ²ĞµÑÑĞµĞ¼, ÑÑĞ¾ Ğ°ÑÑĞ¸Ğ±ÑÑ xlink:href ÑÑÑĞµÑÑĞ²ÑĞµÑ
                if 'xlink:href' in image_element.attrib:
                    link = image_element.attrib['xlink:href']
                else:
                    logger.debug("Element found but 'xlink:href' attribute is missing")
            else:
                logger.debug("No SVG image elements found")
        except Exception as e:
            logger.error(f"Error parsing logo: {e}")
        return link


class FacebookWebPage(Page, FacebookWebParser, FacebookWeb2Parser):
    def __init__(self):
        super().__init__(search_type='business')
        self.required_fields = ['logo', 'address', 'phone', 'email', 'title']

    def worker(self, item: FacebookItem) -> FacebookItem:
        result = item
        try:
            urls = self.extract_facebook_urls(item)
            for web in urls:
                content = self.fetch_content(web)
                if content:
                    result = self.extract_item(content, item)
                if self.is_complete(result):  # ĞÑĞ¾Ğ²ĞµÑÑĞµĞ¼ result, Ğ° Ğ½Ğµ item
                    break
        except Exception as err:
            logger.error(err)
        return result

    def extract_facebook_urls(self, item: FacebookItem) -> list[str]:
        social_links = [social.strip() for social in item.social.split(' | ')]

        if any("facebook.com" in link for link in social_links or []):
            return [link for link in social_links if "facebook.com" in link]
        return []

    def is_complete(self, item: FacebookItem) -> bool:
        """
        Check if the item has all required fields filled.
        :param item: FacebookItem to check.
        :return: True if all required fields are filled, False otherwise.
        """
        return all(getattr(item, field) for field in self.required_fields)

    def _should_update_description(self, original_desc: str, new_desc: str) -> bool:
        """
        ĞĞ¿ÑĞµĞ´ĞµĞ»ÑĞµÑ, Ğ½ÑĞ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ Ğ¿Ğ¾Ğ»Ğµ description.

        ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞµÑĞ»Ğ¸:
        1. ĞÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿ÑÑÑĞ¾Ğµ Ğ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ¿ÑÑÑĞ¾Ğµ
        2. ĞÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ´ĞµÑĞ¶Ğ¸Ñ '...' Ğ² Ğ½Ğ°ÑĞ°Ğ»Ğµ Ğ¸Ğ»Ğ¸ ÑĞµÑĞµĞ´Ğ¸Ğ½Ğµ Ğ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ¿ÑÑÑĞ¾Ğµ

        ĞĞ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞµÑĞ»Ğ¸:
        1. ĞÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ¿ÑÑÑĞ¾Ğµ Ğ¸ Ğ½Ğµ ÑĞ¾Ğ´ĞµÑĞ¶Ğ¸Ñ '...'
        2. '...' Ğ¿ÑĞ¸ÑÑÑÑÑĞ²ÑĞµÑ ÑĞ¾Ğ»ÑĞºĞ¾ Ğ² ĞºĞ¾Ğ½ÑĞµ
        3. ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿ÑÑÑĞ¾Ğµ

        :param original_desc: ĞÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
        :param new_desc: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Facebook
        :return: True ĞµÑĞ»Ğ¸ Ğ½ÑĞ¶Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸ÑÑ, False ĞµÑĞ»Ğ¸ Ğ¾ÑÑĞ°Ğ²Ğ¸ÑÑ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ
        """
        # ĞÑĞ»Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿ÑÑÑĞ¾Ğµ - ĞĞ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼
        if not new_desc or new_desc.strip() == '':
            return False
        
        # ĞÑĞ»Ğ¸ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿ÑÑÑĞ¾Ğµ - Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼
        if not original_desc or original_desc.strip() == '':
            return True
        
        # ĞÑĞ»Ğ¸ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğµ ÑĞ¾Ğ´ĞµÑĞ¶Ğ¸Ñ '...' - ĞĞ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼
        if '...' not in original_desc:
            return False
        
        # ĞÑĞ¾Ğ²ĞµÑÑĞµĞ¼, Ğ³Ğ´Ğµ Ğ½Ğ°ÑĞ¾Ğ´Ğ¸ÑÑÑ '...'
        dots_index = original_desc.find('...')
        
        # ĞÑĞ»Ğ¸ '...' Ğ² ĞºĞ¾Ğ½ÑĞµ - ĞĞ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼
        if dots_index == len(original_desc) - 3:
            return False
        
        # ĞÑĞ»Ğ¸ '...' Ğ² Ğ½Ğ°ÑĞ°Ğ»Ğµ Ğ¸Ğ»Ğ¸ ÑĞµÑĞµĞ´Ğ¸Ğ½Ğµ - Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼
        return True

    def extract_item(self, content: str, item: FacebookItem) -> Optional[FacebookItem]:
        try:
            selector = Selector(text=content)

            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑĞ¹ Ğ¾Ğ±ÑĞµĞºÑ Ñ Ğ´Ğ°Ğ½Ğ½ÑĞ¼Ğ¸ Ğ¸Ğ· Ğ¿Ğ°ÑÑĞ¸Ğ½Ğ³Ğ°
            parsed_description = self.parse_descr(selector)
            
            parsed_data = {
                'keyword': item.keyword,  # Ğ¡Ğ¾ÑÑĞ°Ğ½ÑĞµĞ¼ Ğ¸ÑÑĞ¾Ğ´Ğ½ÑĞ¹ keyword
                'title': self.parse_title(selector),
                'description': parsed_description,
                'web': item.web,  # Ğ¡ĞĞ¥Ğ ĞĞĞ¯ĞĞ ĞĞ¡Ğ¥ĞĞĞĞ«Ğ web, ĞĞ ĞĞĞĞĞĞ¯ĞĞ!
                'phone': self.parse_phone(selector),
                'email': self.parse_email(selector),
                'logo': self.parse_logo(selector),
                'address': self.parse_address(selector),
                'service': '',
                'rating': '',
                'category': '',
                'likes': '',
                'price_range': '',
                'price_delivery': '',
                'social': item.social,  # Ğ¡Ğ¾ÑÑĞ°Ğ½ÑĞµĞ¼ Ğ¸ÑÑĞ¾Ğ´Ğ½ÑĞ¹ social
                'builtwith': item.builtwith,  # Ğ¡Ğ¾ÑÑĞ°Ğ½ÑĞµĞ¼ Ğ¸ÑÑĞ¾Ğ´Ğ½ÑĞ¹ builtwith
                'keyword_match_log': '',
                'relevance_log': '',
                'search_type': '',
                'relevance': 0
            }
            
            result = FacebookItem(**parsed_data)

            # ĞĞ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ»ÑĞºĞ¾ Ğ¿ÑÑÑÑĞµ Ğ¿Ğ¾Ğ»Ñ
            for field in item.model_fields:
                item_value = getattr(item, field)
                result_value = getattr(result, field)

                # Ğ¡Ğ¿ĞµÑĞ¸Ğ°Ğ»ÑĞ½Ğ°Ñ Ğ¾Ğ±ÑĞ°Ğ±Ğ¾ÑĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ description
                if field == 'description':
                    if self._should_update_description(item_value, result_value):
                        setattr(result, field, result_value)
                        logger.info(f"Facebook found description: '{result_value}'")
                    else:
                        setattr(result, field, item_value)
                # ĞĞ»Ñ Ğ¾ÑÑĞ°Ğ»ÑĞ½ÑÑ Ğ¿Ğ¾Ğ»ĞµĞ¹ - ÑÑĞ°Ğ½Ğ´Ğ°ÑÑĞ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
                else:
                    # ĞÑĞ»Ğ¸ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ¿ÑÑÑĞ¾Ğµ, Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ·Ğ½Ğ°ÑĞµĞ½Ğ¸Ğµ ĞµÑÑÑ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑĞ·ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ
                    if not item_value and result_value:
                        setattr(result, field, result_value)
                    # ĞÑĞ»Ğ¸ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ½Ğµ Ğ¿ÑÑÑĞ¾Ğµ - ÑĞ¾ÑÑĞ°Ğ½ÑĞµĞ¼ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ
                    elif item_value:
                        setattr(result, field, item_value)
                    # ĞĞĞĞĞ: ĞÑĞ»Ğ¸ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ½Ğµ Ğ¿ÑÑÑĞ¾Ğµ, Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¿ÑÑÑĞ¾Ğµ - ÑĞ¾ÑÑĞ°Ğ½ÑĞµĞ¼ Ğ¸ÑÑĞ¾Ğ´Ğ½Ğ¾Ğµ
                    elif item_value and not result_value:
                        setattr(result, field, item_value)

            return result

        except Exception as err:
            logger.error(err)
            return None


if __name__ == "__main__":
    # Example usage
    p = FacebookWebPage()
    i = FacebookItem(
        social="https://www.facebook.com/pages/Kims-BBQ-Restaurant/121801967878515",
        keyword="example"
    )
    r = p.worker(i)
    print(r)